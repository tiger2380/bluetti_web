<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlueTooth - Bluetti</title>
    <link rel="stylesheet" href="app.css" />
    <style>
      pre {
        outline: 1px solid #ccc;
        padding: 5px;
        margin: 5px;
      }
      .string {
        color: green;
      }
      .number {
        color: darkorange;
      }
      .boolean {
        color: blue;
      }
      .null {
        color: magenta;
      }
      .key {
        color: red;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <button id="btn">Connect</button>
      <pre>
        <div id="details"></div>
        </pre>
      <div id="chart">
        <p>Chart</p>
        <div
          style="
            width: 500px;
            padding: 0;
            display: flex;
            justify-items: between;
            align-items: center;
            gap: 2;
          "
        >
          <canvas id="batteryChart" style="flex: 1"></canvas>
          <canvas id="powerChart" style="flex: 1"></canvas>
        </div>
        <button onClick="myChart.resetZoom()">Reset Zoom</button>
        <canvas id="myChart"></canvas>
      </div>
      <!--<p>AC OUTPUT: <span id="ac_output"></span></p>
        <p>AC INPUT POWER: <span id="ac_input"></span></p>
        <p>Battery: <span id="battery"></span></p>
        <p>DC INPUT POWER: <span id="dc_input"></span></p>
        <hr />
        <p>AC OUTPUT STATE: <span id="ac_output_state"></span></p>
        <p>DC OUTPUT STATE: <span id="dc_output_state"></span></p>-->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"
      integrity="sha512-wUYbRPLV5zs6IqvWd88HIqZU/b8TBx+I8LEioQ/UC0t5EMCLApqhIAnUg7EsAzdbhhdgW07TqYDdH3QEXRcPOQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="EventEmitter.js"></script>
    <script src="utils.js"></script>
    <script src="enums.js"></script>
    <script src="devices/Parser.js"></script>
    <script src="devices/Commands.js"></script>
    <script src="app.js"></script>
    <script>
      const ctx = document.getElementById("myChart");
      const batteryCtx = document.getElementById("batteryChart");
      const powerCtx = document.getElementById("powerChart");

      const batteryPlugin = {
        id: "batteryPlugin",
        afterDraw: (chart) => {
          const {
            ctx,
            config,
            data,
            chartArea: { top, bottom, left, right, height, width },
          } = chart;
          ctx.restore();
          ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
          ctx.fillRect(left, top, width, height);

          const fontSize = (height / 114).toFixed(2);
          ctx.font = fontSize + "em sans-serif";
          ctx.textBaseline = "middle";

          const text = (chart.data.datasets[0].data[0] || 0) + "%",
            textX = Math.round((width - ctx.measureText(text).width) / 2),
            textY = height - 50;

          ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
          ctx.fillText(text, textX, textY);
          ctx.save();
        },
      };

      const powerChart = new Chart(powerCtx, {
        type: "doughnut",
        data: {
          labels: ["DC Input", "Load"],
          datasets: [
            {
              label: "Power",
              data: [0, 0],
              backgroundColor: [
                "rgba(255, 99, 132, 1)",
                "rgba(54, 162, 235, 1)",
              ],
              borderColor: ["rgba(255, 255, 255 ,1)", "rgba(255, 255, 255 ,1)"],
              borderWidth: 5,
              circumference: 180,
              rotation: 270,
            },
          ],
        },
        options: {
          aspectRatio: 2,
          legend: {
            display: false,
          },
        },
      });

      const chart = new Chart(batteryCtx, {
        type: "doughnut",
        data: {
          labels: ["battery"],
          datasets: [
            {
              label: "Battery Percentage",
              data: [0, 0],
              backgroundColor: [
                "rgba(159, 190, 253, 1)",
                "rgba(255, 255, 255, 1)",
              ],
              borderColor: ["rgba(255, 255, 255 ,1)"],
              borderWidth: 5,
              circumference: 180,
              rotation: 270,
            },
          ],
        },
        options: {
          aspectRatio: 2,
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              filter: (tooltipItem) => {
                return tooltipItem.dataIndex === 0;
              },
            },
          },
        },
        plugins: [batteryPlugin],
      });

      function formatAMPM(date) {
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var seconds = date.getSeconds();
        var ampm = hours >= 12 ? "pm" : "am";
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;
        var strTime = hours + ":" + minutes + ":" + seconds + " " + ampm;
        return strTime;
      }

      const myChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "AC Output",
              data: [0, 0, 0, 0],
              backgroundColor: ["rgba(255, 99, 132, 0.2)"],
              borderColor: ["rgba(255, 99, 132, 1)"],
              borderWidth: 1,
              fill: true,
            },
            {
              label: "AC Input",
              data: [0, 0, 0, 0],
              backgroundColor: ["rgba(54, 162, 235, 0.2)"],
              borderColor: ["rgba(54, 162, 235, 1)"],
              borderWidth: 1,
              fill: true,
            },
            {
              label: "Battery",
              data: [0, 0, 0, 0],
              backgroundColor: ["rgba(255, 206, 86, 0.2)"],
              borderColor: ["rgba(255, 206, 86, 1)"],
              borderWidth: 1,
              fill: true,
            },
            {
              label: "DC Input",
              data: [0, 0, 0, 0],
              backgroundColor: ["rgba(75, 192, 192, 0.2)"],
              borderColor: ["rgba(75, 192, 192, 1)"],
              borderWidth: 1,
              fill: true,
            },
          ],
        },
        options: {
          interaction: {
            intersect: false,
            mode: "index",
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Time",
              },
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Power (W)",
              },
            },
          },
          plugins: {
            title: {
              display: true,
              text: "Overall View",
            },
            subtitle: {
              display: true,
              text: "Click and drag to zoom | ctrl+drag to pan",
              color: "gray",
              font: {
                size: 12,
                family: "arial, sans-serif",
                weight: "normal",
              },
              padding: {
                bottom: 10,
              },
            },
            zoom: {
              zoom: {
                drag: {
                  enabled: true,
                },
                mode: "x",
                onZoomComplete: (chart) => {
                  const zoomLevel = chart.chart.getZoomLevel();
                  if (zoomLevel < 1) {
                    chart.chart.resetZoom();
                  }
                },
              },
              pan: {
                enabled: true,
                mode: "x",
                modifierKey: "ctrl",
              },
            },
          },
        },
      });

      window.myChart = myChart;
      const now = new Date();
      myChart.data.labels.push(
        now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds()
      );

      myChart.update();
      window.eventEmitter.on("update", (data) => {
        const time = new Date();
        const timeStr =
          time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds();

        if (timeStr === "00:00:00") {
          // take a capture of mychart canvas
          const image = myChart.toBase64Image();

          // save image to file
          const link = document.createElement("a");
          link.download = `performance-${timeStr}.png`;
          link.href = image;
          link.click();

          // clear mychart
          myChart.data.labels = [];
          myChart.data.datasets[0].data = [];
          myChart.data.datasets[1].data = [];
          myChart.data.datasets[2].data = [];
          myChart.data.datasets[3].data = [];
        }

        myChart.data.datasets[0].data.push(data.ac_output_power);
        myChart.data.datasets[1].data.push(data.ac_input_power);
        myChart.data.datasets[2].data.push(data.battery);
        myChart.data.datasets[3].data.push(data.dc_input_power);

        //if (time.getMinutes() === 0 && time.getSeconds() === 0) {
        myChart.data.labels.push(formatAMPM(time));
        //} else {
        //   myChart.data.labels.push('');
        //}

        myChart.update();

        chart.data.datasets[0].data[0] = data.battery;
        chart.data.datasets[0].data[1] = 100 - data.battery;
        chart.update();

        powerChart.data.datasets[0].data[0] = data.dc_input_power;
        powerChart.data.datasets[0].data[1] = data.ac_output_power;
        powerChart.update();
      });
    </script>
  </body>
</html>
